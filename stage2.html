<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stage 2 — Market Analysis</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>Stage 2 — Market Analysis</h1>
      <div class="progress-bar"><div class="progress" style="width:40%"></div></div>
    </header>

    <section>
      <div class="memo-card">
        <p>Repeat purchase sits at <strong>6%</strong>. Feedback highlights off-taste, price barrier, and label mistrust.</p>
      </div>

      <div class="task-card">
        <h3>Interactive Puzzle A — Priority Slots Dilemma</h3>
        <p>Drag the four issues into priority slots <strong>Immediate</strong>, <strong>Short-term</strong>, <strong>Medium</strong>, <strong>Low</strong>. Your rankings affect the points — taste first is best.</p>

        <div class="priority-board">
          <div class="issues-pool" id="issuesPool">
            <div draggable="true" class="issue" data-issue="off-taste">Off-taste Quality</div>
            <div draggable="true" class="issue" data-issue="price">Price Affordability</div>
            <div draggable="true" class="issue" data-issue="label">Label Mistrust</div>
            <div draggable="true" class="issue" data-issue="pack">Packaging Complaints</div>
          </div>

          <div class="priority-slots">
            <div class="slot" data-slot="Immediate">
              <h4>Immediate</h4>
              <div class="slotzone" data-slot="Immediate"></div>
            </div>
            <div class="slot" data-slot="Short-term">
              <h4>Short-term</h4>
              <div class="slotzone" data-slot="Short-term"></div>
            </div>
            <div class="slot" data-slot="Medium">
              <h4>Medium</h4>
              <div class="slotzone" data-slot="Medium"></div>
            </div>
            <div class="slot" data-slot="Low">
              <h4>Low</h4>
              <div class="slotzone" data-slot="Low"></div>
            </div>
          </div>
        </div>

        <div style="margin-top:10px">
          <button class="submit-btn" id="prioritySubmit">Submit Priority</button>
        </div>
        <div id="priorityResult" class="result"></div>
      </div>

      <div class="task-card">
        <h3>Interactive Puzzle B — Budget Balancer (Trade-off)</h3>
        <p>You have <strong>1,000,000</strong>. Allocate across <em>Sachet pilot</em>, <em>Coupons</em>, <em>Local sampling events</em>. Balanced allocation yields the best clue.</p>

        <div class="budget-grid">
          <div>
            <label>Sachet pilot <span id="sachetVal">300,000</span></label>
            <input type="range" id="sachet" min="0" max="1000000" step="10000" value="300000" />
          </div>
          <div>
            <label>Coupons <span id="couponVal">300,000</span></label>
            <input type="range" id="coupon" min="0" max="1000000" step="10000" value="300000" />
          </div>
          <div>
            <label>Sampling <span id="sampleVal">400,000</span></label>
            <input type="range" id="sample" min="0" max="1000000" step="10000" value="400000" />
          </div>
        </div>

        <div style="margin-top:10px">
          <button class="submit-btn" id="budgetSubmit">Submit Budget</button>
        </div>
        <div id="budgetResult" class="result"></div>
      </div>

      <div style="margin-top:14px">
        <button id="toStage3Btn" class="next-btn" disabled onclick="goToStage('stage3.html')">Proceed to Stage 3</button>
      </div>
    </section>
  </div>

  <aside id="leaderboardSidebar">
    <h3>Leaderboard</h3>
    <ol id="leaderboardList"></ol>
    <div id="yourSession" style="margin-top:12px;font-size:14px"></div>
  </aside>

  <script src="game.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Drag priorities
      const issues = document.querySelectorAll('.issue');
      issues.forEach(it => it.addEventListener('dragstart', ev => {
        ev.dataTransfer.setData('text/plain', ev.target.dataset.issue);
      }));

      const slotzones = document.querySelectorAll('.slotzone');
      slotzones.forEach(z => {
        z.addEventListener('dragover', ev => ev.preventDefault());
        z.addEventListener('drop', ev => {
          ev.preventDefault();
          const id = ev.dataTransfer.getData('text/plain');
          const node = document.querySelector(`.issue[data-issue="${id}"]`);
          if (!node) return;
          // Remove previous placement of this issue
          document.querySelectorAll('.slotzone').forEach(s => {
            if (s.contains(node)) s.innerHTML = '';
          });
          ev.target.innerHTML = '';
          ev.target.appendChild(node);
        });
      });

      document.getElementById('prioritySubmit').addEventListener('click', () => {
        const session = loadSession();
        if (!session) return alert('Start the game first.');

        const placed = {};
        slotzones.forEach(s => {
          const child = s.querySelector('.issue');
          placed[s.dataset.slot] = child ? child.dataset.issue : null;
        });

        // Scoring: Immediate off-taste = 60; Short-term label = 30; Medium price or pack = 15
        let pts = 0;
        if (placed['Immediate'] === 'off-taste') pts += 60;
        if (placed['Short-term'] === 'label') pts += 30;
        if (placed['Medium'] === 'price' || placed['Medium'] === 'pack') pts += 15;

        awardStageTaskPoints('st2priority', pts);
        document.getElementById('priorityResult').textContent = `Priority slot scored ${pts} pts.`;
        document.getElementById('prioritySubmit').disabled = true;

        if (getStageTaskDone('st2priority') && getStageTaskDone('st2budget')) {
          document.getElementById('toStage3Btn').disabled = false;
        }
      });

      // Budget sliders
      const sachet = document.getElementById('sachet');
      const coupon = document.getElementById('coupon');
      const sample = document.getElementById('sample');
      const sVal = document.getElementById('sachetVal');
      const cVal = document.getElementById('couponVal');
      const smVal = document.getElementById('sampleVal');

      function refreshVals() {
        sVal.textContent = Number(sachet.value).toLocaleString();
        cVal.textContent = Number(coupon.value).toLocaleString();
        smVal.textContent = Number(sample.value).toLocaleString();
      }
      sachet.addEventListener('input', refreshVals);
      coupon.addEventListener('input', refreshVals);
      sample.addEventListener('input', refreshVals);

      document.getElementById('budgetSubmit').addEventListener('click', () => {
        const session = loadSession();
        if (!session) return alert('Start the game first.');

        const total = Number(sachet.value) + Number(coupon.value) + Number(sample.value);
        if (total !== 1000000) return alert('You must allocate the full 1,000,000 across the three channels.');

        // Good balance: sachet 250k–500k (40), sampling ≥200k (30), coupons ≈350k (30). Bonus 25 if all true, cap 100.
        let pts = 0;
        const s = Number(sachet.value);
        const co = Number(coupon.value);
        const sm = Number(sample.value);

        if (s >= 250000 && s <= 500000) pts += 40;
        if (sm >= 200000) pts += 30;
        if (co >= 330000 && co <= 370000) pts += 30;

        if (pts >= 100) pts = 100; else if (pts >= 100 - 25) pts += 25; // bonus if close to perfect mix

        pts = Math.min(100, pts);

        awardStageTaskPoints('st2budget', pts);
        document.getElementById('budgetResult').textContent = `Budget allocation scored ${pts} pts.`;
        document.getElementById('budgetSubmit').disabled = true;

        if (getStageTaskDone('st2priority') && getStageTaskDone('st2budget')) {
          document.getElementById('toStage3Btn').disabled = false;
        }
      });

      // Restore if previously done
      const session = loadSession();
      if (session) {
        if (getStageTaskDone('st2priority')) document.getElementById('prioritySubmit').disabled = true;
        if (getStageTaskDone('st2budget')) document.getElementById('budgetSubmit').disabled = true;
      }
      refreshVals();
    });
  </script>
</body>
</html>

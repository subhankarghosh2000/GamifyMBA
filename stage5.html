<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stage 5 — Final Pitch</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>Stage 5 — Final Boardroom Pitch</h1>
      <div class="progress-bar"><div class="progress" style="width:100%"></div></div>
    </header>

    <section>
      <h2>Case Summary</h2>
      <ul>
        <li>10K actual vs 100K expected sales</li>
        <li>Repeat purchase rate 5%</li>
        <li>30% bottles leaking</li>
        <li>Competitor cheaper by 7%</li>
      </ul>

      <h3>Select 4–5 Key Actions</h3>
      <form id="actionForm" class="action-checkboxes">
        <label><input type="checkbox" name="action" value="reduce-price" /> Reduce price by 5%</label><br />
        <label><input type="checkbox" name="action" value="fix-packaging" /> Fix packaging leakage</label><br />
        <label><input type="checkbox" name="action" value="expand-distribution" /> Expand to 1500 kirana stores</label><br />
        <label><input type="checkbox" name="action" value="increase-marketing" /> Increase rural marketing by 3x</label><br />
        <label><input type="checkbox" name="action" value="launch-sachets" /> Launch affordable sachets</label><br />
        <label><input type="checkbox" name="action" value="partner-anganwadi" /> Partner with local centers</label><br />
        <label><input type="checkbox" name="action" value="improve-quality" /> Improve product formulation</label><br />
        <button type="button" id="submitActions" class="submit-btn">Submit Actions</button>
      </form>

      <h3>Your Turnaround Pitch (50–200 words)</h3>
      <textarea id="pitchText" maxlength="1200" placeholder="Write your compelling turnaround strategy..."></textarea>
      <p>Words <span id="wordCount">0</span>/200</p>
      <button type="button" id="submitPitchBtn" class="submit-btn" disabled>Submit Final Pitch</button>
      <div id="pitchFeedback" style="margin-top: 12px; font-weight:bold"></div>

      <div id="finalResults" style="display:none; margin-top:20px">
        <h3>Final Score</h3>
        <p id="scoreLine"></p>
        <div id="finalLeaderboard"></div>
        <button class="start-btn" onclick="restartGame()">Play Again</button>
      </div>
    </section>
  </div>

  <aside id="leaderboardSidebar">
    <h3>Leaderboard</h3>
    <ol id="leaderboardList"></ol>
    <div id="yourSession" style="margin-top:12px;font-size:14px"></div>
  </aside>

  <script src="game.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const pitchText = document.getElementById('pitchText');
      const wordCount = document.getElementById('wordCount');
      const submitPitchBtn = document.getElementById('submitPitchBtn');
      const submitActions = document.getElementById('submitActions');

      pitchText.addEventListener('input', () => {
        const words = (pitchText.value.match(/\b\w+\b/g) || []).length;
        wordCount.textContent = words;
        submitPitchBtn.disabled = !(words >= 50 && words <= 200 && getStageTaskDone('st5actions'));
      });

      submitActions.addEventListener('click', () => {
        const selected = Array.from(document.querySelectorAll('#actionForm input[name="action"]:checked'))
          .map(x => x.value);
        if (selected.length < 4 || selected.length > 5) {
          alert('Please select 4 to 5 actions.');
          return;
        }
        let pts = 0;
        const must = ['fix-packaging','launch-sachets','improve-quality','expand-distribution'];
        must.forEach(m => { if (selected.includes(m)) pts += 25; });
        if (selected.includes('partner-anganwadi')) pts += 10;
        if (selected.includes('reduce-price')) pts += 10;

        pts = Math.min(100, Math.max(0, pts));
        awardStageTaskPoints('st5actions', pts);
        alert(`Actions submitted — ${pts} points.`);
        submitActions.disabled = true;
        // Enable pitch once actions submitted and word count ok
        const words = (pitchText.value.match(/\b\w+\b/g) || []).length;
        submitPitchBtn.disabled = !(words >= 50 && words <= 200);
      });

      submitPitchBtn.addEventListener('click', () => {
        const text = pitchText.value.trim();
        const words = (text.match(/\b\w+\b/g) || []).length;
        if (words < 50) return alert('Write at least 50 words.');

        // Keyword scoring heuristic
        let bonus = 0;
        const lower = text.toLowerCase();
        if (lower.includes('recall') || lower.includes('apology')) bonus += 25;
        if (lower.includes('local') || lower.includes('bottler') || lower.includes('sachet')) bonus += 30;
        if (lower.includes('quality') || lower.includes('qa')) bonus += 25;
        if (lower.includes('price') || lower.includes('promo')) bonus += 15;

        bonus = Math.min(100, bonus);
        awardStageTaskPoints('st5pitch', bonus);
        document.getElementById('pitchFeedback').textContent = `Pitch submitted — ${bonus} pts.`;
        submitPitchBtn.disabled = true;

        finalizeGame();
      });

      const session = loadSession();
      if (session) {
        if (getStageTaskDone('st5actions')) document.getElementById('submitActions').disabled = true;
        if (getStageTaskDone('st5pitch')) document.getElementById('submitPitchBtn').disabled = true;
      }
    });
  </script>
</body>
</html>

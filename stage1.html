<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stage 1 â€” The Incident</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ›‘ Stage 1 â€” The Incident</h1>
      <div class="progress-bar"><div class="progress" style="width:20%"></div></div>
    </header>

    <section class="evidence-section">
      <h2>Initial Evidence</h2>

      <div class="evidence-card">
        <h3>Sales snapshot</h3>
        <p>Targets vs actuals show major shortfall in EMEA, APAC and Country Y has the worst sentiment.</p>
      </div>

      <div class="evidence-card">
        <h3>Leaked clip</h3>
        <p>A social thread claims "Label says 'Made from local fruit' but bottles are from concentrate â€” misleading!"</p>
      </div>
    </section>

    <div class="task-card">
      <h3>Interactive Puzzle A â€” Air Freight Allocation (Logistics Dilemma)</h3>
      <p>You have <strong>2 emergency planes</strong>; each can cover one region quickly. Regions need urgent air shipments to avoid stockouts: EMEA 2 loads, APAC 2 loads, Country Y 1 load. Drag plane tokens to regions to minimise stockout risk. Each correct allocation gives points. Allocate both planes.</p>

      <div class="allocator">
        <div id="planePool" class="plane-pool">
          <div draggable="true" class="plane" id="plane1">Plane 1</div>
          <div draggable="true" class="plane" id="plane2">Plane 2</div>
        </div>

        <div class="regions">
          <div class="region" id="EMEA" data-need="2">
            <h4>EMEA needs 2</h4>
            <div class="dropzone" data-region="EMEA"></div>
          </div>
          <div class="region" id="APAC" data-need="2">
            <h4>APAC needs 2</h4>
            <div class="dropzone" data-region="APAC"></div>
          </div>
          <div class="region" id="CountryY" data-need="1">
            <h4>Country Y needs 1</h4>
            <div class="dropzone" data-region="CountryY"></div>
          </div>
        </div>
      </div>

      <div style="margin-top:10px">
        <button class="submit-btn" id="allocSubmit">Submit Allocation</button>
      </div>
      <div id="allocResult" class="result"></div>
    </div>

    <div class="task-card">
      <h3>Interactive Puzzle B â€” Label Thread Decode (Speed)</h3>
      <p>A blurred screenshot of social replies is shown. Slide the decoder to reveal text gradually. Spot the misleading phrase and type it exactly. Faster reveals yield more points.</p>

      <div class="decoder">
        <div class="blurred" id="blurredText">Made from local fruit</div>
        <input type="range" id="decoderRange" min="0" max="100" value="0" />
        <input type="text" id="decodedInput" placeholder="Type the misleading phrase you found" />
        <button class="submit-btn" id="decodeSubmit">Submit Phrase</button>
      </div>
      <div id="decodeResult" class="result"></div>
    </div>

    <div style="margin-top:14px">
      <button id="toStage2Btn" class="next-btn" disabled onclick="goToStage('stage2.html')">Proceed to Stage 2</button>
    </div>
  </div>

  <aside id="leaderboardSidebar">
    <h3>Leaderboard</h3>
    <ol id="leaderboardList"></ol>
    <div id="yourSession" style="margin-top:12px;font-size:14px"></div>
  </aside>

  <script src="game.js"></script>
  <script>
    // Drag & drop for planes
    document.addEventListener('DOMContentLoaded', () => {
      const planes = document.querySelectorAll('.plane');
      planes.forEach(p => {
        p.addEventListener('dragstart', ev => {
          ev.dataTransfer.setData('text/plain', ev.target.id);
        });
      });

      const zones = document.querySelectorAll('.dropzone');
      zones.forEach(z => {
        z.addEventListener('dragover', ev => ev.preventDefault());
        z.addEventListener('drop', ev => {
          ev.preventDefault();
          const id = ev.dataTransfer.getData('text/plain');
          const node = document.getElementById(id);
          if (!node) return;
          ev.target.innerHTML = '';
          ev.target.appendChild(node);
        });
      });

      document.getElementById('allocSubmit').addEventListener('click', () => {
        const session = loadSession();
        if (!session) return alert('Start the game (index) first.');

        const zoneEMEA = document.querySelector('.dropzone[data-region="EMEA"] .plane') ? 1 : 0;
        const zoneAPAC = document.querySelector('.dropzone[data-region="APAC"] .plane') ? 1 : 0;
        const zoneY    = document.querySelector('.dropzone[data-region="CountryY"] .plane') ? 1 : 0;

        let points = 0;
        if (zoneY === 1) points += 50;      // PR hotspot
        if (zoneEMEA === 1) points += 25;
        if (zoneAPAC === 1) points += 25;
        points = Math.min(100, points);

        awardStageTaskPoints('st1alloc', points);
        document.getElementById('allocResult').innerHTML = `Allocation scored ${points} pts.`;

        document.getElementById('allocSubmit').disabled = true;
        if (getStageTaskDone('st1alloc') && getStageTaskDone('st1decode')) {
          document.getElementById('toStage2Btn').disabled = false;
        }
      });

      const decoder = document.getElementById('decoderRange');
      const blurred = document.getElementById('blurredText');
      decoder.addEventListener('input', (ev) => {
        const v = Number(ev.target.value);
        blurred.style.opacity = String(Math.max(0.3, 1 - v/120));
      });

      document.getElementById('decodeSubmit').addEventListener('click', () => {
        const session = loadSession();
        if (!session) return alert('Start the game first.');
        const answer = document.getElementById('decodedInput').value.trim();
        if (!answer) return alert('Type the phrase you spotted.');
        const expected = 'Made from local fruit';
        const sim = textSimilarity(answer, expected);

        const sliderVal = Number(decoder.value);
        const speedBonus = Math.max(0, 40 - sliderVal);
        const base = Math.round(sim * 60);
        const points = Math.min(100, base + Math.round(speedBonus * 0.8));

        awardStageTaskPoints('st1decode', points);
        document.getElementById('decodeResult').innerHTML =
          `Decoded similarity ${Math.round(sim*100)}%. ${points} pts.`;
        document.getElementById('decodeSubmit').disabled = true;

        if (getStageTaskDone('st1alloc') && getStageTaskDone('st1decode')) {
          document.getElementById('toStage2Btn').disabled = false;
        }
      });

      // Restore disabled state on reload
      const session = loadSession();
      if (session) {
        if (getStageTaskDone('st1alloc')) document.getElementById('allocSubmit').disabled = true;
        if (getStageTaskDone('st1decode')) document.getElementById('decodeSubmit').disabled = true;
      }
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stage 3 — Internal Audit</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>Stage 3 — Internal Audit</h1>
      <div class="progress-bar"><div class="progress" style="width:60%"></div></div>
    </header>

    <section>
      <div class="memo-card">
        <p>Cost overruns on packaging and distribution. QA sampling rates were reduced to meet timelines. Customers report off-taste and leakage.</p>
      </div>

      <div class="task-card">
        <h3>Interactive Puzzle A — Rebuild QA Checkpoints (Drag to Flow)</h3>
        <p>Drag QA checkpoints into the correct places on the production flow: Mixing, Pasteurization, Filling, Sealing, Packaging. Place at least 3 checkpoints.</p>

        <div class="flow-builder">
          <div class="flow-diagram">
            <div class="step" data-step="Mixing">Mixing<div class="slotzone" data-step="Mixing"></div></div>
            <div class="step" data-step="Pasteurization">Pasteurization<div class="slotzone" data-step="Pasteurization"></div></div>
            <div class="step" data-step="Filling">Filling<div class="slotzone" data-step="Filling"></div></div>
            <div class="step" data-step="Sealing">Sealing<div class="slotzone" data-step="Sealing"></div></div>
            <div class="step" data-step="Packaging">Packaging<div class="slotzone" data-step="Packaging"></div></div>
          </div>

          <div class="qa-pool">
            <div draggable="true" class="qa" data-qa="IngredientCheck">Ingredient Check</div>
            <div draggable="true" class="qa" data-qa="TempLog">Temperature Log</div>
            <div draggable="true" class="qa" data-qa="FillWeight">Fill Weight Check</div>
            <div draggable="true" class="qa" data-qa="SealIntegrity">Seal Integrity</div>
            <div draggable="true" class="qa" data-qa="FinalSample">Final Sample Tasting</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <button class="submit-btn" id="qaSubmit">Submit QA Map</button>
        </div>
        <div id="qaResult" class="result"></div>
      </div>

      <div class="task-card">
        <h3>Interactive Puzzle B — Spot the Packaging Defect (Click to Find)</h3>
        <p>Three sample product photos are shown. Click the parts of the image that show packing defects (leak, poor seal, misprint). You have 90 seconds — speed adds bonus points.</p>

        <div class="images-row">
          <div class="img-box" id="img1" data-def="leak">
            <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='300' height='180'><rect width='300' height='180' rx='8' fill='%23f3f4f6'/><text x='150' y='90' dominant-baseline='middle' text-anchor='middle' fill='%23666' font-size='18'>Bottle A (click leak)</text></svg>" alt="img1" />
          </div>
          <div class="img-box" id="img2" data-def="seal">
            <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='300' height='180'><rect width='300' height='180' rx='8' fill='%23f8fafc'/><text x='150' y='90' dominant-baseline='middle' text-anchor='middle' fill='%23666' font-size='18'>Bottle B (click poor seal)</text></svg>" alt="img2" />
          </div>
          <div class="img-box" id="img3" data-def="misprint">
            <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='300' height='180'><rect width='300' height='180' rx='8' fill='%23fff7f0'/><text x='150' y='90' dominant-baseline='middle' text-anchor='middle' fill='%23666' font-size='18'>Bottle C (click misprint)</text></svg>" alt="img3" />
          </div>
        </div>

        <div style="margin-top:10px">
          <button class="submit-btn" id="imgStart">Start Spotting (90s)</button>
        </div>
        <div id="imgResult" class="result"></div>
      </div>

      <div style="margin-top:14px">
        <button id="toStage4Btn" class="next-btn" disabled onclick="goToStage('stage4.html')">Proceed to Stage 4</button>
      </div>
    </section>
  </div>

  <aside id="leaderboardSidebar">
    <h3>Leaderboard</h3>
    <ol id="leaderboardList"></ol>
    <div id="yourSession" style="margin-top:12px;font-size:14px"></div>
  </aside>

  <script src="game.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // QA drag/drop
      const qas = document.querySelectorAll('.qa');
      qas.forEach(q => q.addEventListener('dragstart', ev => {
        ev.dataTransfer.setData('text/plain', ev.target.dataset.qa);
      }));

      const slotzones = document.querySelectorAll('.flow-diagram .slotzone');
      slotzones.forEach(z => {
        z.addEventListener('dragover', ev => ev.preventDefault());
        z.addEventListener('drop', ev => {
          ev.preventDefault();
          const id = ev.dataTransfer.getData('text/plain');
          const node = document.querySelector(`.qa[data-qa="${id}"]`);
          if (!node) return;
          // one QA per slot
          ev.target.innerHTML = '';
          ev.target.appendChild(node);
        });
      });

      document.getElementById('qaSubmit').addEventListener('click', () => {
        const session = loadSession();
        if (!session) return alert('Start the game first.');

        const mapping = {
          Mixing: 'IngredientCheck',
          Pasteurization: 'TempLog',
          Filling: 'FillWeight',
          Sealing: 'SealIntegrity',
          Packaging: 'FinalSample'
        };
        let score = 0;
        Object.keys(mapping).forEach(step => {
          const z = document.querySelector(`.slotzone[data-step="${step}"]`);
          if (z && z.querySelector('.qa') && z.querySelector('.qa').dataset.qa === mapping[step]) {
            score += 20;
          }
        });

        awardStageTaskPoints('st3qa', score);
        document.getElementById('qaResult').innerHTML = `QA placement scored ${score} pts.`;
        document.getElementById('qaSubmit').disabled = true;

        if (getStageTaskDone('st3qa') && getStageTaskDone('st3spot')) {
          document.getElementById('toStage4Btn').disabled = false;
        }
      });

      // Spot-the-defect mini-game
      let imgTimer = null, timeLeft = 90, found = 0, started = false, startTime = 0;

      function finishSpotting() {
        const end = Date.now();
        const elapsed = Math.round((end - startTime)/1000);

        let base = Math.min(60, found * 20);
        let speedBonus = 0;
        if (found === 3) {
          if (elapsed <= 30) speedBonus = 30;
          else if (elapsed <= 60) speedBonus = 20;
          else speedBonus = 10;
        } else {
          speedBonus = Math.max(0, 10 - (3 - found) * 3);
        }
        const total = Math.min(100, base + speedBonus);

        awardStageTaskPoints('st3spot', total);
        document.getElementById('imgResult').textContent =
          `Found ${found} defects. Score ${total} pts.`;
        document.querySelectorAll('.img-box').forEach(b => {
          b.replaceWith(b.cloneNode(true)); // remove handlers
        });
        document.getElementById('imgStart').disabled = true;

        if (getStageTaskDone('st3qa') && getStageTaskDone('st3spot')) {
          document.getElementById('toStage4Btn').disabled = false;
        }
      }

      document.getElementById('imgStart').addEventListener('click', () => {
        if (started) return;
        started = true; found = 0; timeLeft = 90; startTime = Date.now();
        document.getElementById('imgResult').textContent = `Timer ${timeLeft}s — Click defects now!`;
        imgTimer = setInterval(() => {
          timeLeft--;
          if (timeLeft <= 0) {
            clearInterval(imgTimer);
            finishSpotting();
          } else {
            document.getElementById('imgResult').textContent = `Timer ${timeLeft}s — Click defects now!`;
          }
        }, 1000);

        document.querySelectorAll('.img-box').forEach(b => {
          b.addEventListener('click', (ev) => {
            const box = ev.currentTarget;
            if (box.classList.contains('found')) return;
            box.classList.add('found');
            box.style.outline = '4px solid #00b894';
            found++;
            if (found >= 3) {
              clearInterval(imgTimer);
              finishSpotting();
            }
          });
        });
      });

      const session = loadSession();
      if (session) {
        if (getStageTaskDone('st3qa')) document.getElementById('qaSubmit').disabled = true;
        if (getStageTaskDone('st3spot')) document.getElementById('imgStart').disabled = true;
      }
    });
  </script>
</body>
</html>

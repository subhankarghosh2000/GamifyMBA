<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stage 4 — Competitor Market</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>Stage 4 — Competitor Market</h1>
      <div class="progress-bar"><div class="progress" style="width:80%"></div></div>
    </header>

    <section>
      <div class="memo-card">
        <p>Competitor sells sachets widely at <strong>$0.25</strong>. Brand Z price is <strong>$1.10</strong>. Local sourcing is low. Distribution centralised.</p>
      </div>

      <div class="task-card">
        <h3>Interactive Puzzle A — Price vs Share (Trade-Off Slider)</h3>
        <p>Slide the trade-off between <strong>High Price Low Share</strong> and <strong>Low Price High Share</strong>. Pick a point and justify with a short note (20–120 chars). The sachet pilot sweet spot near the low-price side scores most.</p>

        <input type="range" id="priceSlider" min="0" max="100" value="40" />
        <div style="margin-top:6px">
          <input type="text" id="priceNote" placeholder="Type short justification (20-120 chars)" />
        </div>
        <div style="margin-top:8px">
          <button class="submit-btn" id="priceSubmit">Submit Price Decision</button>
        </div>
        <div id="priceResult" class="result"></div>
      </div>

      <div class="task-card">
        <h3>Interactive Puzzle B — Localisation Match (Drag-Pair)</h3>
        <p>Match the marketing slogans to the correct country/cultural cues by dragging slogan tiles onto country cards. Correct cultural matches score higher.</p>

        <div class="match-area">
          <div class="slogans">
            <div draggable="true" class="slogan" data-slogan="s1">Fresh like your morning</div>
            <div draggable="true" class="slogan" data-slogan="s2">Bold spice, bold life</div>
            <div draggable="true" class="slogan" data-slogan="s3">Share a moment, taste home</div>
          </div>

          <div class="countries">
            <div class="country" data-country="CountryA">
              <h4>Country A — urban, coffee culture</h4>
              <div class="dropzone" data-country="CountryA"></div>
            </div>
            <div class="country" data-country="CountryB">
              <h4>Country B — spice-forward markets</h4>
              <div class="dropzone" data-country="CountryB"></div>
            </div>
            <div class="country" data-country="CountryC">
              <h4>Country C — family-sharing culture</h4>
              <div class="dropzone" data-country="CountryC"></div>
            </div>
          </div>
        </div>

        <div style="margin-top:8px">
          <button class="submit-btn" id="localSubmit">Submit Matches</button>
        </div>
        <div id="localResult" class="result"></div>
      </div>

      <div style="margin-top:14px">
        <button id="toStage5Btn" class="next-btn" disabled onclick="goToStage('stage5.html')">Proceed to Final Pitch</button>
      </div>
    </section>
  </div>

  <aside id="leaderboardSidebar">
    <h3>Leaderboard</h3>
    <ol id="leaderboardList"></ol>
    <div id="yourSession" style="margin-top:12px;font-size:14px"></div>
  </aside>

  <script src="game.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('priceSubmit').addEventListener('click', () => {
        const session = loadSession();
        if (!session) return alert('Start the game first.');
        const val = Number(document.getElementById('priceSlider').value);
        const note = document.getElementById('priceNote').value.trim();
        if (note.length < 20) return alert('Write at least 20 characters justification.');

        // Ideal sweet spot 20–45 leaning to sachet; note mentions add bonus
        let pts = 0;
        if (val >= 20 && val <= 45) pts = 60;
        else if (val >= 46 && val <= 65) pts = 30;
        else pts = 10;

        const low = note.toLowerCase();
        if (low.includes('sachet') || low.includes('pilot') || low.includes('local')) pts += 25;
        pts = Math.min(100, pts);

        awardStageTaskPoints('st4price', pts);
        document.getElementById('priceResult').textContent = `Price trade-off scored ${pts} pts.`;
        document.getElementById('priceSubmit').disabled = true;

        if (getStageTaskDone('st4price') && getStageTaskDone('st4local')) {
          document.getElementById('toStage5Btn').disabled = false;
        }
      });

      // Drag-pair localisation
      const slogans = document.querySelectorAll('.slogan');
      slogans.forEach(s => s.addEventListener('dragstart', ev => {
        ev.dataTransfer.setData('text/plain', s.dataset.slogan);
      }));

      const drops = document.querySelectorAll('.country .dropzone');
      drops.forEach(d => {
        d.addEventListener('dragover', ev => ev.preventDefault());
        d.addEventListener('drop', ev => {
          ev.preventDefault();
          const id = ev.dataTransfer.getData('text/plain');
          const node = document.querySelector(`.slogan[data-slogan="${id}"]`);
          if (!node) return;
          // Remove previous placement of this slogan
          document.querySelectorAll('.dropzone').forEach(z => {
            if (z.contains(node)) z.innerHTML = '';
          });
          ev.target.innerHTML = '';
          ev.target.appendChild(node);
        });
      });

      document.getElementById('localSubmit').addEventListener('click', () => {
        const session = loadSession();
        if (!session) return alert('Start the game first.');

        let pts = 0;
        if (document.querySelector('.dropzone[data-country="CountryA"] .slogan')?.dataset.slogan === 's1') pts += 40;
        if (document.querySelector('.dropzone[data-country="CountryB"] .slogan')?.dataset.slogan === 's2') pts += 40;
        if (document.querySelector('.dropzone[data-country="CountryC"] .slogan')?.dataset.slogan === 's3') pts += 40;
        pts = Math.min(100, pts);

        awardStageTaskPoints('st4local', pts);
        document.getElementById('localResult').textContent = `Localisation matched ${pts} pts.`;
        document.getElementById('localSubmit').disabled = true;

        if (getStageTaskDone('st4price') && getStageTaskDone('st4local')) {
          document.getElementById('toStage5Btn').disabled = false;
        }
      });

      // Restore
      const session = loadSession();
      if (session) {
        if (getStageTaskDone('st4price')) document.getElementById('priceSubmit').disabled = true;
        if (getStageTaskDone('st4local')) document.getElementById('localSubmit').disabled = true;
      }
    });
  </script>
</body>
</html>
